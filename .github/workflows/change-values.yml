
on:
  workflow_call:
    inputs:
      secret_name:
        required: false
        type: string
        description: "Secret name in kubernetes cluster"
        default: "basegun-secret"
      namespace:
        required: true
        type: string
        description: "Namespace name in kubernetes cluster"
        default: "basegun"
      branch:
        required: true
        type: string
        description: "Branche de d√©ploiement"
    secrets:
      SA_SECRET:
        description: 'Service account secret (run kubectl get serviceaccounts <service-account-name> -o yaml and copy the service-account-secret-name)'
        required: true
      CLUSTER_URL:
        required: true
      X_OVH_TOKEN:
        required: true
      API_OVH_TOKEN:
        required: true
      OS_PASSWORD:
        required: true
      OS_PROJECT_NAME:
        required: true
      OS_USERNAME:
        required: true
      JOB_GITHUB_TOKEN:
        required: true

jobs:
  deployment:
    name: Update deployment
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout branch
      uses: actions/checkout@v2
      with:
        ref: ${{ inputs.branch }}

    - uses: azure/k8s-set-context@v3
      with:
        method: service-account
        k8s-url: ${{ secrets.CLUSTER_URL }}
        k8s-secret: ${( secrets.SA_SECRET }}

    - name: Create secret for Kubernetes
      uses: azure/k8s-create-secret@v2
      with:
        namespace: ${{ inputs.namespace }}
        secret-type: 'generic'
        secret-name: ${{ inputs.secret_name }}
        stringData: |-
          {
          "OS_PASSWORD": ${{ secrets.OS_PASSWORD }},
          "OS_PROJECT_NAME": ${{ secrets.OS_PROJECT_NAME }},
          "OS_USERNAME": ${{ secrets.OS_USERNAME }},
          "X_OVH_TOKEN": ${{ secrets.X_OVH_TOKEN }},
          "API_OVH_TOKEN": ${{ secrets.API_OVH_TOKEN }}
          }

    - name: Install yq
      run: |
        wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && chmod +x /usr/bin/yq

    - name: Update Infra Version
      run: |
          export TAG=$(make get-current-tag)
          yq -i '.backend.image.tag = strenv(TAG)' ./infra/kube/basegun/values.yaml
          yq -i '.frontend.image.tag = strenv(TAG)' ./infra/kube/basegun/values.yaml

    - name: Commit and push changes
      uses: devops-infra/action-commit-push@v0.3
      with:
        github_token: ${{ secrets.JOB_GITHUB_TOKEN }}
        commit_prefix: "[skip ci]"
        commit_message: "Version updated"
